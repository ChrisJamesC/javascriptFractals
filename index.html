<style type="text/css">
html, body {
  padding; 0;
  margin: 0;
}
body {
  background:#000;
  color:white;
  font-family: Arial,Helvetica,Sans-serif;
  font-size: 12px;
}
a:hover {
  text-decoration: none;
}
canvas {
  position: absolute;
  cursor: crosshair;
}
#tools {
  color: #eee;
  position: fixed;
  top: 44px;
  left: 12px;
  line-height: 18px;
  padding: 6px 8px 6px 8px;
  z-index: 10;
  background: rgba(0,0,0,0.6);
  height: 40px;
  border-radius: 4px;
}
#tools:hover {
  opacity: 1;
}
#tools > div {
  width: 80px;
  float: left;
}
#tools input[type=text] {
  color: #fff;
  font-weight: bold;
  width: 70px;
  margin: 0 0 4px 0;
  padding: 4px 5px;
  background: rgba(0,0,0,0.1);
  border: none;
}
#tools:hover input[type=text] {
  color: #eee;
}
#zoom {
  position: fixed;
  top: 12px;
  left: 12px;
  font-size: 24px;
  line-height: 24px;
  font-weight: bold;
  text-align: center;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}
#zoom > div {
  float: left;
  width: 24px;
  background: rgba(0,0,0,0.6);
  border-radius: 4px;
  margin-right: 4px;
  padding: 2px;
}
#zoom > div:hover {
  cursor: pointer;
  background: rgba(0,0,0,1);
}
#zoom-reset {
  font-size: 16px;
  -webkit-transform: rotate(90deg); 
  -moz-transform: rotate(90deg); 
}
#zoom-gear {
  font-size: 16px;
  color: rgba(255,255,255,0.3);
}
#zoom-gear:hover {
  color: rgba(255,255,255,1);
}
#zoom-gear.active {
  color: inherit;
}
</style>
<canvas id="theCanvas" width="803" height="400"></canvas>
<canvas id="interactionCanvas" width="803" height="400"></canvas>
<div id="zoom">
  <div id="zoom-in" title="Zoom in">+</div>
  <div id="zoom-out" title="Zoom out">-</div>
  <div id="zoom-reset" title="Reset zoom">&sect;</div>
  <div id="zoom-gear" title="Change fractal parameters">&#9881;</div>
</div>
<div id="tools" style="display:none">
</div>
<script src="http://d3js.org/d3.v2.js"></script>
<script src="http://underscorejs.org/underscore.js"></script>
<script src="julia.js"></script>
<script>
var width = document.body.clientWidth;
var height = document.body.clientHeight;
var canvas = document.getElementById('theCanvas');
var interaction_canvas = document.getElementById('interactionCanvas');

var real_scale = d3.scale.linear()
  .domain([0, width])
  .range([-1.7,1.7]);

var imag_scale = d3.scale.linear()
  .domain([0, height])
  .range([-1,1]);

d3.selectAll("canvas")
  .attr("width", width)
  .attr("height", height);

var ctx = canvas.getContext('2d'); 
var interaction_context = interaction_canvas.getContext('2d'); 

jul = julia(width,height)
  .context(ctx);

jul.color = d3.scale.linear()
      .domain([0, 12, 30, 50, 100, 180, 260, 380, 600, 800, 1200, 1600,3200])
      .range(["moccasin", "#999", "steelblue", "yellow", "brown", "#222", "pink", "purple", "#027", "#260", "orange", "yellow", "blue"])
      .interpolate(d3.interpolateHcl);

// bind inputs to julia parameters
d3.keys(jul.__).forEach(function(key) {
  d3.select("#tools")
    .append("div")
    .html(key + "<br/>")
    .append("input")
    .attr({
      id: "input-" + key,
      type: "text",
      value: jul[key]()
    })
    .on("keyup", function() {
      jul[key](this.value);
    });
});

jul.render();
jul.go();

// toggle tools visibility
var gear_active = false;
d3.select("#zoom-gear").on("click", function() {
  gear_active = !gear_active;
  d3.select("#tools").style("display", function() { return gear_active ? "block" : "none" });
  d3.select(this).classed("active", gear_active);
});
d3.select("#zoom-reset").on("click", function() {
  var box = [
    real_scale.invert(-1.7),
    imag_scale.invert(-1),
    real_scale.invert(1.7),
    imag_scale.invert(1)
  ];
  d3.select("#input-realMin").attr("value", real_scale(box[0]));
  d3.select("#input-imagMin").attr("value", imag_scale(box[1]));
  d3.select("#input-realMax").attr("value", real_scale(box[2]));
  d3.select("#input-imagMax").attr("value", imag_scale(box[3]));
  real_scale.range([real_scale(box[0]), real_scale(box[2])]);
  imag_scale.range([imag_scale(box[1]), imag_scale(box[3])]);
  interaction_context.clearRect(0,0,width,height);  
  jul.zoom(box[0], box[1], box[2]-box[0], box[3]-box[1]);
});
d3.select("#zoom-in").on("click", function() {
  var real_mod = 0.1 * (jul.realMax() - jul.realMin());
  var imag_mod = 0.1 * (jul.imagMax() - jul.imagMin());
  var box = [
    real_scale.invert(jul.realMin() + real_mod),
    imag_scale.invert(jul.imagMin() + imag_mod),
    real_scale.invert(jul.realMax() - real_mod),
    imag_scale.invert(jul.imagMax() - imag_mod)
  ];
  d3.select("#input-realMin").attr("value", real_scale(box[0]));
  d3.select("#input-imagMin").attr("value", imag_scale(box[1]));
  d3.select("#input-realMax").attr("value", real_scale(box[2]));
  d3.select("#input-imagMax").attr("value", imag_scale(box[3]));
  real_scale.range([real_scale(box[0]), real_scale(box[2])]);
  imag_scale.range([imag_scale(box[1]), imag_scale(box[3])]);
  interaction_context.clearRect(0,0,width,height);  
  jul.zoom(box[0], box[1], box[2]-box[0], box[3]-box[1]);
});
d3.select("#zoom-out").on("click", function() {
  var real_mod = 0.125 * (jul.realMax() - jul.realMin());
  var imag_mod = 0.125 * (jul.imagMax() - jul.imagMin());
  var box = [
    real_scale.invert(jul.realMin() - real_mod),
    imag_scale.invert(jul.imagMin() - imag_mod),
    real_scale.invert(jul.realMax() + real_mod),
    imag_scale.invert(jul.imagMax() + imag_mod)
  ];
  d3.select("#input-realMin").attr("value", real_scale(box[0]));
  d3.select("#input-imagMin").attr("value", imag_scale(box[1]));
  d3.select("#input-realMax").attr("value", real_scale(box[2]));
  d3.select("#input-imagMax").attr("value", imag_scale(box[3]));
  real_scale.range([real_scale(box[0]), real_scale(box[2])]);
  imag_scale.range([imag_scale(box[1]), imag_scale(box[3])]);
  interaction_context.clearRect(0,0,width,height);  
  jul.zoom(box[0], box[1], box[2]-box[0], box[3]-box[1]);
});
/*
d3.select(interaction_canvas)
  .call(
    d3.behavior.zoom()
      .x(real_scale)
      .y(imag_scale)
      .on("zoom", function(a,b) { 
        console.log(d3.event.scale, d3.event.translate);
      })
  );
  */

var extentMin = [],
    extentMax = [];

d3.select(interaction_canvas)
  .call(
    d3.behavior.drag()
    .on("dragstart", dragstart)
    .on("drag", dragging)
    .on("dragend", dragend)
  );

function dragstart() {
  extentMin = d3.mouse(this);
};

function dragend() {
  extentMax = d3.mouse(this);
  var box = [
    d3.min([extentMin[0],extentMax[0]]),
    d3.min([extentMin[1],extentMax[1]]),
    d3.max([extentMin[0],extentMax[0]]),
    d3.max([extentMin[1],extentMax[1]])
  ];
  if (box[0] == box[2] || box[1] == box[3]) return;
  if (_.isNaN(box[0]) ||
      _.isNaN(box[1]) ||
      _.isNaN(box[2]) ||
      _.isNaN(box[3])) return;
  d3.select("#input-realMin").attr("value", real_scale(box[0]));
  d3.select("#input-imagMin").attr("value", imag_scale(box[1]));
  d3.select("#input-realMax").attr("value", real_scale(box[2]));
  d3.select("#input-imagMax").attr("value", imag_scale(box[3]));
  real_scale.range([real_scale(box[0]), real_scale(box[2])]);
  imag_scale.range([imag_scale(box[1]), imag_scale(box[3])]);
  interaction_context.clearRect(0,0,width,height);  
  jul.zoom(box[0], box[1], box[2]-box[0], box[3]-box[1]);
};

function dragging() {
  extentMax = d3.mouse(this);
  interaction_context.clearRect(0,0,width,height);  
  interaction_context.fillStyle = "rgba(0,0,0,0.7)";
  interaction_context.fillRect(0,0,width,height);  
  interaction_context.clearRect(extentMin[0],
                                extentMin[1],
                                extentMax[0]-extentMin[0],
                                extentMax[1]-extentMin[1]);
};

window.onresize = function() {
  width = document.body.clientWidth;
  height = document.body.clientHeight;

  var real_scale = d3.scale.linear()
    .domain([0, width])

  var imag_scale = d3.scale.linear()
    .domain([0, height])

  jul.x_extent(width);
  jul.y_extent(height);

  d3.selectAll("canvas")
    .attr("width", width)
    .attr("height", height);
};
</script>